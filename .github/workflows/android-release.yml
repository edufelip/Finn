name: Android Release

on:
  workflow_dispatch: {}
  push:
    branches:
      - release/**
      - hotfix/**
    paths-ignore:
      - "supabase/**"
      - "docs/**"
      - "web/**"

jobs:
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    steps:
      - uses: actions/checkout@v4
      - name: Write env files
        run: |
          cat <<'EOF' > .env.production
          ${{ secrets.ENV_FILE }}
          EOF
          cp .env.production .env
        working-directory: .
      - name: Export env vars
        run: |
          tr -d '\r' < .env.production | \
            awk '/^[[:space:]]*(export[[:space:]]+)?EXPO_PUBLIC_[A-Za-z0-9_]+=/ { sub(/^[[:space:]]*export[[:space:]]+/, "", $0); print $0; }' \
            >> "$GITHUB_ENV"
        working-directory: .

      - name: Set Expo environment
        run: |
          echo "APP_ENV=prod" >> "$GITHUB_ENV"
          echo "APP_VARIANT=prod" >> "$GITHUB_ENV"
          echo "EXPO_PUBLIC_APP_ENV=prod" >> "$GITHUB_ENV"
          echo "EXPO_PUBLIC_APP_VARIANT=prod" >> "$GITHUB_ENV"
          echo "NODE_ENV=production" >> "$GITHUB_ENV"
        working-directory: .

      - name: Validate Expo environment
        run: |
          if [ "$APP_ENV" != "prod" ]; then
            echo "APP_ENV must be 'prod' (got '$APP_ENV')" >&2
            exit 1
          fi
          echo "APP_ENV=$APP_ENV"
          echo "EXPO_PUBLIC_APP_ENV=$EXPO_PUBLIC_APP_ENV"
        working-directory: .

      - name: Validate Firebase secrets
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "GOOGLE_SERVICES_JSON_BASE64 is not set" >&2
            exit 1
          fi
        working-directory: .
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install JS deps
        run: npm ci --include=dev
        working-directory: .
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Install Android NDK r28
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          if [ -z "$SDK_ROOT" ]; then
            echo "ANDROID_SDK_ROOT or ANDROID_HOME must be set" >&2
            exit 1
          fi
          SDKMANAGER="$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -x "$SDKMANAGER" ]; then
            SDKMANAGER="$SDK_ROOT/cmdline-tools/bin/sdkmanager"
          fi
          if [ ! -x "$SDKMANAGER" ]; then
            echo "sdkmanager not found under $SDK_ROOT/cmdline-tools" >&2
            exit 1
          fi
          yes | "$SDKMANAGER" --sdk_root="$SDK_ROOT" "ndk;28.0.12433566"
          if [ ! -d "$SDK_ROOT/ndk/28.0.12433566" ]; then
            echo "NDK install failed (missing $SDK_ROOT/ndk/28.0.12433566)" >&2
            exit 1
          fi
      - name: Set CI version code
        run: echo "CI_VERSION_CODE=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > app/finn-release-key.jks

      - name: Create keystore.properties
        run: |
          cat <<EOF > keystore.properties
          storeFile=app/finn-release-key.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
          EOF

      - name: Write google-services.json
        run: |
          mkdir -p app
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > app/google-services.json

      - name: Build release bundle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          build-root-directory: android
          arguments: |
            clean
            bundleRelease
            -PCI_VERSION_CODE=${{ env.CI_VERSION_CODE }}

      - name: Validate 16 KB page size alignment
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          NDK_ROOT="$SDK_ROOT/ndk/28.0.12433566"
          READELF="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf"
          if [ ! -x "$READELF" ]; then
            echo "llvm-readelf not found at $READELF" >&2
            exit 1
          fi
          AAB_FILE="app/build/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_FILE" ]; then
            echo "AAB file not found at $AAB_FILE" >&2
            exit 1
          fi
          TMP_DIR=$(mktemp -d)
          unzip -q "$AAB_FILE" -d "$TMP_DIR"
          READELF="$READELF" TMP_DIR="$TMP_DIR" python3 - <<'PY'
          import os
          import subprocess
          import sys
          
          readelf = os.environ["READELF"]
          root = os.environ["TMP_DIR"]
          bad = []
          checked = 0
          
          for dirpath, _, filenames in os.walk(root):
            for name in filenames:
              if not name.endswith(".so"):
                continue
              path = os.path.join(dirpath, name)
              try:
                output = subprocess.check_output([readelf, "-lW", path], text=True)
              except subprocess.CalledProcessError as exc:
                print(f"Failed to read ELF headers for {path}: {exc}", file=sys.stderr)
                sys.exit(1)
              checked += 1
              for line in output.splitlines():
                if line.strip().startswith("LOAD"):
                  align = line.split()[-1]
                  if align.startswith("0x") and int(align, 16) < 0x4000:
                    bad.append((path, align))
                    break
          
          if checked == 0:
            print("No native libraries found in AAB.")
            sys.exit(0)
          
          if bad:
            print("âŒ Found libraries not aligned for 16 KB pages:")
            for path, align in bad:
              rel = os.path.relpath(path, root)
              print(f" - {rel} (align {align})")
            sys.exit(1)
          
          print(f"âœ… All {checked} native libraries are 16 KB aligned.")
          PY

      - name: Verify mapping file exists
        run: |
          if [ ! -f app/build/outputs/mapping/release/mapping.txt ]; then
            echo "âŒ ERROR: Mapping file not found!"
            echo "Expected: app/build/outputs/mapping/release/mapping.txt"
            ls -la app/build/outputs/mapping/ || true
            exit 1
          fi
          echo "âœ… Mapping file generated successfully"
          echo "Size: $(du -h app/build/outputs/mapping/release/mapping.txt | cut -f1)"

      - name: Find and package native debug symbols
        run: |
          echo "ðŸ” Searching for native libraries in build output..."
          
          # List possible locations
          echo "Checking possible symbol locations:"
          find app/build/intermediates -type d -name "lib" 2>/dev/null | grep -E "(merged_native_libs|stripped_native_libs|library_jni)" | head -10 || true
          
          # Try multiple possible locations (ordered by preference)
          SYMBOLS_DIR=""
          POSSIBLE_DIRS=(
            "app/build/intermediates/merged_native_libs/release/out/lib"
            "app/build/intermediates/library_jni/release/jni"
            "app/build/intermediates/stripped_native_libs/release/out/lib"
            "app/build/intermediates/merged_native_libs/release/lib"
          )
          
          for dir in "${POSSIBLE_DIRS[@]}"; do
            if [ -d "$dir" ] && [ -n "$(find "$dir" -name "*.so" -type f 2>/dev/null)" ]; then
              SYMBOLS_DIR="$dir"
              echo "âœ… Found native symbols at: $SYMBOLS_DIR"
              break
            fi
          done
          
          if [ -z "$SYMBOLS_DIR" ]; then
            echo "âš ï¸  Warning: Native symbols directory not found in standard locations"
            echo "This might be expected for some build configurations."
            echo "Checking if AAB contains native code..."
            
            # Extract AAB to check for native libs
            AAB_FILE="app/build/outputs/bundle/release/app-release.aab"
            if [ -f "$AAB_FILE" ]; then
              TEMP_DIR=$(mktemp -d)
              unzip -q "$AAB_FILE" -d "$TEMP_DIR" 2>/dev/null || true
              
              if [ -d "$TEMP_DIR/base/lib" ]; then
                echo "âœ… Found native libraries inside AAB at base/lib/"
                SYMBOLS_DIR="$TEMP_DIR/base/lib"
              else
                echo "â„¹ï¸  No native libraries found in AAB"
                echo "This app might not have native dependencies requiring symbols"
                exit 0
              fi
            else
              echo "âŒ ERROR: AAB file not found at $AAB_FILE"
              exit 1
            fi
          fi
          
          # Display found symbols
          echo ""
          echo "ðŸ“¦ Native symbol files found:"
          echo "Architectures:"
          ls -la "$SYMBOLS_DIR"
          echo ""
          echo "Symbol files:"
          find "$SYMBOLS_DIR" -name "*.so" -type f | while read f; do
            echo "  - $(basename $(dirname $f))/$(basename $f) ($(du -h $f | cut -f1))"
          done
          
          # Create zip
          SYMBOLS_ZIP="app/build/outputs/native-debug-symbols.zip"
          mkdir -p app/build/outputs
          cd "$SYMBOLS_DIR"
          zip -r "$GITHUB_WORKSPACE/android/$SYMBOLS_ZIP" . -i "*.so"
          
          echo ""
          echo "âœ… Native debug symbols zip created"
          echo "Location: $SYMBOLS_ZIP"
          echo "Size: $(du -h $GITHUB_WORKSPACE/android/$SYMBOLS_ZIP | cut -f1)"
          
          # Save the symbols dir for cleanup if needed
          echo "SYMBOLS_DIR=$SYMBOLS_DIR" >> $GITHUB_ENV

      - name: Sign bundle with jarsigner
        env:
          STOREPASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEYPASS: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore app/finn-release-key.jks \
            -storepass "$STOREPASS" \
            -keypass "$KEYPASS" \
            app/build/outputs/bundle/release/app-release.aab \
            ${{ secrets.ANDROID_KEY_ALIAS }}

      - name: Upload mapping file artifact
        uses: actions/upload-artifact@v4
        with:
          name: mapping-file
          path: android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 90

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.aab
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Upload native debug symbols artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-debug-symbols
          path: android/app/build/outputs/native-debug-symbols.zip
          retention-days: 90

      - name: Upload to Play (internal track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.edufelip.finn
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: draft
          mappingFile: android/app/build/outputs/mapping/release/mapping.txt
          debugSymbols: android/app/build/outputs/native-debug-symbols.zip
          # status: completed
